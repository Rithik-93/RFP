generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Chat Conversations
model Conversation {
  id        String   @id @default(uuid())
  title     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages Message[]

  @@map("conversations")
}

model Message {
  id             String      @id @default(uuid())
  conversationId String
  role           MessageRole
  content        String      @db.Text
  createdAt      DateTime    @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("messages")
}

enum MessageRole {
  user
  assistant
}

model RFP {
  id               String    @id @default(uuid())
  title            String
  description      String
  requirements     Json // AI-extracted structured requirements
  budget           Decimal   @db.Decimal(12, 2)
  currency         String    @default("USD")
  deliveryDeadline DateTime
  createdBy        String?
  status           RFPStatus @default(DRAFT)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  vendors   RFPVendor[]
  proposals Proposal[]

  @@map("rfps")
}

model Vendor {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  phone     String?
  address   Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  rfps      RFPVendor[]
  proposals Proposal[]

  @@map("vendors")
}

model Proposal {
  id              String         @id @default(uuid())
  rfpId           String
  vendorId        String
  rfpReplyId      String?        @unique
  rawEmailContent String         @db.Text
  parsedData      Json
  attachments     Json[]
  status          ProposalStatus @default(RECEIVED)
  receivedAt      DateTime       @default(now())
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  rfp      RFP       @relation(fields: [rfpId], references: [id], onDelete: Cascade)
  vendor   Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  rfpReply RFPReply? @relation(fields: [rfpReplyId], references: [id])

  @@map("proposals")
}

model RFPVendor {
  id            String          @id @default(uuid())
  rfpId         String
  vendorId      String
  sentMessageId String?
  sentAt        DateTime?
  openedAt      DateTime?
  respondedAt   DateTime?
  status        RFPVendorStatus @default(PENDING)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  rfp     RFP        @relation(fields: [rfpId], references: [id], onDelete: Cascade)
  vendor  Vendor     @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  replies RFPReply[]

  @@unique([rfpId, vendorId])
  @@map("rfp_vendors")
}

model RFPReply {
  id             String    @id @default(uuid())
  rfpVendorId    String
  emailMessageId String    @unique
  inReplyTo      String
  from           String
  subject        String
  body           String    @db.Text
  type           ReplyType @default(PENDING)
  parsedData     Json?
  createdAt      DateTime  @default(now())
  files          String[]

  rfpVendor RFPVendor @relation(fields: [rfpVendorId], references: [id], onDelete: Cascade)
  proposal  Proposal?

  @@map("rfp_replies")
}

model EmailLog {
  id        String         @id @default(uuid())
  rfpId     String?
  vendorId  String?
  direction EmailDirection
  subject   String
  body      String         @db.Text
  messageId String
  status    EmailStatus
  metadata  Json?
  createdAt DateTime       @default(now())

  @@map("email_logs")
}

// Enums
enum RFPStatus {
  DRAFT
  SENT
  CLOSED
  CANCELLED
}

enum VendorStatus {
  ACTIVE
  INACTIVE
  BLACKLISTED
}

enum ProposalStatus {
  RECEIVED
  UNDER_REVIEW
  ACCEPTED
  REJECTED
}

enum ReplyType {
  PENDING
  PROPOSAL
  QUESTION
  CLARIFICATION
  DECLINE
  OTHER
}

enum RFPVendorStatus {
  PENDING
  SENT
  RESPONDED
  NO_RESPONSE
}

enum EmailDirection {
  INBOUND
  OUTBOUND
}

enum EmailStatus {
  SENT
  FAILED
  RECEIVED
}
